<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>
  File: README
  
    &mdash; Documentation by YARD 0.7.2
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" media="screen" charset="utf-8" />

  <link rel="stylesheet" href="css/common.css" type="text/css" media="screen" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  relpath = '';
  if (relpath != '') relpath += '/';
</script>

  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <script type="text/javascript" charset="utf-8">
      if (window.top.frames.main) document.body.className = 'frames';
    </script>
    
    <div id="header">
      <div id="menu">
  
    <a href="_index.html" title="Index">Index</a> &raquo; 
    <span class="title">File: README</span>
  
  
  <div class="noframes"><span class="title">(</span><a href="." target="_top">no frames</a><span class="title">)</span></div>
</div>

      <div id="search">
  
    <a id="class_list_link" href="#">Class List</a>
  
    <a id="method_list_link" href="#">Method List</a>
  
    <a id="file_list_link" href="#">File List</a>
  
</div>
      <div class="clear"></div>
    </div>
    
    <iframe id="search_frame"></iframe>
    
    <div id="content"><div id='filecontents'><h1>WebMock</h1>

<h2>Unstable v2.0 branch!</h2>

<pre class="code">Don't use this branch, use the master branch. This is where I'm
doing a lot a refactoring and trying out some new features that
won't be ready for a while.
</pre>

<p>Library for stubbing and setting expectations on HTTP requests in Ruby.</p>

<h2>Features</h2>

<ul>
<li>Stubbing HTTP requests at low http client lib level (no need to change tests when you change HTTP library)</li>
<li>Setting and verifying expectations on HTTP requests</li>
<li>Matching requests based on method, URI, headers and body</li>
<li>Smart matching of the same URIs in different representations (also encoded and non encoded forms)</li>
<li>Smart matching of the same headers in different representations.</li>
<li>Support for Test::Unit</li>
<li>Support for RSpec 1.x and RSpec 2.x</li>
</ul>


<h2>Supported HTTP libraries</h2>

<ul>
<li>Net::HTTP and libraries based on Net::HTTP (i.e RightHttpConnection, REST Client, HTTParty)</li>
<li>HTTPClient</li>
<li>Patron</li>
<li>EM-HTTP-Request</li>
<li>Curb (currently only Curb::Easy)</li>
</ul>


<h2>Installation</h2>

<pre class="code">gem install webmock --source http://gemcutter.org
</pre>

<h3>or to install the latest development version from github master</h3>

<pre class="code"><span class='id git'>git</span> <span class='id clone'>clone</span> <span class='label'>http:</span><span class='tstring'><span class='regexp_beg'>/</span><span class='regexp_end'>/github</span></span><span class='period'>.</span><span class='id com'>com</span><span class='op'>/</span><span class='id bblimke'>bblimke</span><span class='op'>/</span><span class='id webmock'>webmock</span><span class='period'>.</span><span class='id git'>git</span>
<span class='id cd'>cd</span> <span class='id webmock'>webmock</span>
<span class='id rake'>rake</span> <span class='id install'>install</span>
</pre>

<h3>Test::Unit</h3>

<p>Add the following code to <code>test/test_helper.rb</code></p>

<pre class="code"><span class='id require'>require</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>webmock/test_unit</span><span class='tstring_end'>'</span></span>
</pre>

<h3>RSpec</h3>

<p>Add the following code to <code>spec/spec_helper</code>:</p>

<pre class="code"><span class='id require'>require</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>webmock/rspec</span><span class='tstring_end'>'</span></span>
</pre>

<h3>Cucumber</h3>

<p>Add the following code to <code>features/support/env.rb</code></p>

<pre class="code"><span class='id require'>require</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>webmock/cucumber</span><span class='tstring_end'>'</span></span>
</pre>

<p>You can also use WebMock outside a test framework:</p>

<pre class="code"><span class='id require'>require</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>webmock</span><span class='tstring_end'>'</span></span>
<span class='id include'>include</span> <span class='const'>WebMock</span><span class='op'>::</span><span class='const'>API</span>
</pre>

<h2>Examples</h2>

<h2>Stubbing</h2>

<h3>Stubbed request based on uri only and with the default response</h3>

<pre class="code"> <span class='id stub_request'>stub_request</span><span class='lparen'>(</span><span class='symbol'>:any</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>www.example.com</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>

 <span class='const'>Net</span><span class='op'>::</span><span class='const'>HTTP</span><span class='period'>.</span><span class='id get'>get</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>www.example.com</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>    <span class='comment'># ===&gt; Success
</span></pre>

<h3>Stubbing requests based on method, uri, body and headers</h3>

<pre class="code"><span class='id stub_request'>stub_request</span><span class='lparen'>(</span><span class='symbol'>:post</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>www.example.com</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id with'>with</span><span class='lparen'>(</span><span class='symbol'>:body</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>abc</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='symbol'>:headers</span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>Content-Length</span><span class='tstring_end'>'</span></span> <span class='op'>=&gt;</span> <span class='int'>3</span> <span class='rbrace'>}</span><span class='rparen'>)</span>

<span class='id uri'>uri</span> <span class='op'>=</span> <span class='const'>URI</span><span class='period'>.</span><span class='id parse'>parse</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>http://www.example.com/</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
<span class='id req'>req</span> <span class='op'>=</span> <span class='const'>Net</span><span class='op'>::</span><span class='const'>HTTP</span><span class='op'>::</span><span class='const'>Post</span><span class='period'>.</span><span class='id new'>new</span><span class='lparen'>(</span><span class='id uri'>uri</span><span class='period'>.</span><span class='id path'>path</span><span class='rparen'>)</span>
<span class='id req'>req</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>Content-Length</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='int'>3</span>
<span class='id res'>res</span> <span class='op'>=</span> <span class='const'>Net</span><span class='op'>::</span><span class='const'>HTTP</span><span class='period'>.</span><span class='id start'>start</span><span class='lparen'>(</span><span class='id uri'>uri</span><span class='period'>.</span><span class='id host'>host</span><span class='comma'>,</span> <span class='id uri'>uri</span><span class='period'>.</span><span class='id port'>port</span><span class='rparen'>)</span> <span class='lbrace'>{</span><span class='op'>|</span><span class='id http'>http</span><span class='op'>|</span>
  <span class='id http'>http</span><span class='period'>.</span><span class='id request'>request</span><span class='lparen'>(</span><span class='id req'>req</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>abc</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
<span class='rbrace'>}</span>    <span class='comment'># ===&gt; Success
</span></pre>

<h3>Matching request body and headers against regular expressions</h3>

<pre class="code"><span class='id stub_request'>stub_request</span><span class='lparen'>(</span><span class='symbol'>:post</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>www.example.com</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span>
  <span class='id with'>with</span><span class='lparen'>(</span><span class='symbol'>:body</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>^.*world$</span><span class='regexp_end'>/</span></span><span class='comma'>,</span> <span class='symbol'>:headers</span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Content-Type</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>image\/.+</span><span class='regexp_end'>/</span></span><span class='rbrace'>}</span><span class='rparen'>)</span><span class='period'>.</span><span class='id to_return'>to_return</span><span class='lparen'>(</span><span class='symbol'>:body</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>abc</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>

<span class='id uri'>uri</span> <span class='op'>=</span> <span class='const'>URI</span><span class='period'>.</span><span class='id parse'>parse</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>http://www.example.com/</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span>
<span class='id req'>req</span> <span class='op'>=</span> <span class='const'>Net</span><span class='op'>::</span><span class='const'>HTTP</span><span class='op'>::</span><span class='const'>Post</span><span class='period'>.</span><span class='id new'>new</span><span class='lparen'>(</span><span class='id uri'>uri</span><span class='period'>.</span><span class='id path'>path</span><span class='rparen'>)</span>
<span class='id req'>req</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>Content-Type</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>image/png</span><span class='tstring_end'>'</span></span>
<span class='id res'>res</span> <span class='op'>=</span> <span class='const'>Net</span><span class='op'>::</span><span class='const'>HTTP</span><span class='period'>.</span><span class='id start'>start</span><span class='lparen'>(</span><span class='id uri'>uri</span><span class='period'>.</span><span class='id host'>host</span><span class='comma'>,</span> <span class='id uri'>uri</span><span class='period'>.</span><span class='id port'>port</span><span class='rparen'>)</span> <span class='lbrace'>{</span><span class='op'>|</span><span class='id http'>http</span><span class='op'>|</span>
  <span class='id http'>http</span><span class='period'>.</span><span class='id request'>request</span><span class='lparen'>(</span><span class='id req'>req</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>hello world</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span>
<span class='rbrace'>}</span>    <span class='comment'># ===&gt; Success
</span></pre>

<h3>Matching request body against a hash. Body can be URL-Encoded, JSON or XML.</h3>

<pre class="code"><span class='id stub_http_request'>stub_http_request</span><span class='lparen'>(</span><span class='symbol'>:post</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>www.example.com</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span>
    <span class='id with'>with</span><span class='lparen'>(</span><span class='symbol'>:body</span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span><span class='symbol'>:data</span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span><span class='symbol'>:a</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>1</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='symbol'>:b</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>five</span><span class='tstring_end'>'</span></span><span class='rbrace'>}</span><span class='rbrace'>}</span><span class='rparen'>)</span>

<span class='const'>RestClient</span><span class='period'>.</span><span class='id post'>post</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>www.example.com</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>data[a]=1&amp;data[b]=five</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
  <span class='symbol'>:content_type</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>application/x-www-form-urlencoded</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span>    <span class='comment'># ===&gt; Success
</span>
<span class='const'>RestClient</span><span class='period'>.</span><span class='id post'>post</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>www.example.com</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>{&quot;data&quot;:{&quot;a&quot;:&quot;1&quot;,&quot;b&quot;:&quot;five&quot;}}</span><span class='tstring_end'>'</span></span><span class='comma'>,</span>
  <span class='symbol'>:content_type</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>application/json</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span>    <span class='comment'># ===&gt; Success
</span>
<span class='const'>RestClient</span><span class='period'>.</span><span class='id post'>post</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>www.example.com</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>&lt;data a=&quot;1&quot; b=&quot;five&quot; /&gt;</span><span class='tstring_end'>'</span></span><span class='comma'>,</span>
  <span class='symbol'>:content_type</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>application/xml</span><span class='tstring_end'>'</span></span> <span class='rparen'>)</span>    <span class='comment'># ===&gt; Success
</span></pre>

<h3>Matching custom request headers</h3>

<pre class="code"><span class='id stub_request'>stub_request</span><span class='lparen'>(</span><span class='symbol'>:any</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>www.example.com</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id with'>with</span><span class='lparen'>(</span><span class='symbol'>:headers</span><span class='op'>=&gt;</span><span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>Header-Name</span><span class='tstring_end'>'</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>Header-Value</span><span class='tstring_end'>'</span></span> <span class='rbrace'>}</span><span class='rparen'>)</span>

<span class='id uri'>uri</span> <span class='op'>=</span> <span class='const'>URI</span><span class='period'>.</span><span class='id parse'>parse</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>http://www.example.com/</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span>
<span class='id req'>req</span> <span class='op'>=</span> <span class='const'>Net</span><span class='op'>::</span><span class='const'>HTTP</span><span class='op'>::</span><span class='const'>Post</span><span class='period'>.</span><span class='id new'>new</span><span class='lparen'>(</span><span class='id uri'>uri</span><span class='period'>.</span><span class='id path'>path</span><span class='rparen'>)</span>
<span class='id req'>req</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>Header-Name</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>Header-Value</span><span class='tstring_end'>'</span></span>
<span class='id res'>res</span> <span class='op'>=</span> <span class='const'>Net</span><span class='op'>::</span><span class='const'>HTTP</span><span class='period'>.</span><span class='id start'>start</span><span class='lparen'>(</span><span class='id uri'>uri</span><span class='period'>.</span><span class='id host'>host</span><span class='comma'>,</span> <span class='id uri'>uri</span><span class='period'>.</span><span class='id port'>port</span><span class='rparen'>)</span> <span class='lbrace'>{</span><span class='op'>|</span><span class='id http'>http</span><span class='op'>|</span>
  <span class='id http'>http</span><span class='period'>.</span><span class='id request'>request</span><span class='lparen'>(</span><span class='id req'>req</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>abc</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span>
<span class='rbrace'>}</span>    <span class='comment'># ===&gt; Success
</span></pre>

<h3>Matching multiple headers with the same name</h3>

<pre class="code"><span class='id stub_http_request'>stub_http_request</span><span class='lparen'>(</span><span class='symbol'>:get</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>www.example.com</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id with'>with</span><span class='lparen'>(</span><span class='symbol'>:headers</span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>Accept</span><span class='tstring_end'>'</span></span> <span class='op'>=&gt;</span> <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>image/jpeg</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>image/png</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span> <span class='rbrace'>}</span><span class='rparen'>)</span>

<span class='id req'>req</span> <span class='op'>=</span> <span class='const'>Net</span><span class='op'>::</span><span class='const'>HTTP</span><span class='op'>::</span><span class='const'>Get</span><span class='period'>.</span><span class='id new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
<span class='id req'>req</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>Accept</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>image/png</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span>
<span class='id req'>req</span><span class='period'>.</span><span class='id add_field'>add_field</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>Accept</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>image/jpeg</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span>
<span class='const'>Net</span><span class='op'>::</span><span class='const'>HTTP</span><span class='period'>.</span><span class='id start'>start</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>www.example.com</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='lbrace'>{</span><span class='op'>|</span><span class='id http'>http</span><span class='op'>|</span>  <span class='id http'>http</span><span class='period'>.</span><span class='id request'>request</span><span class='lparen'>(</span><span class='id req'>req</span><span class='rparen'>)</span> <span class='rbrace'>}</span> <span class='comment'># ===&gt; Success
</span></pre>

<h3>Matching requests against provided block</h3>

<pre class="code"><span class='id stub_request'>stub_request</span><span class='lparen'>(</span><span class='symbol'>:post</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>www.example.com</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id with'>with</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id request'>request</span><span class='op'>|</span> <span class='id request'>request</span><span class='period'>.</span><span class='id body'>body</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>abc</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span>
<span class='const'>RestClient</span><span class='period'>.</span><span class='id post'>post</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>www.example.com</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>abc</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span>    <span class='comment'># ===&gt; Success
</span></pre>

<h3>Request with basic authentication</h3>

<pre class="code"><span class='id stub_request'>stub_request</span><span class='lparen'>(</span><span class='symbol'>:get</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>user:pass@www.example.com</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>

<span class='const'>Net</span><span class='op'>::</span><span class='const'>HTTP</span><span class='period'>.</span><span class='id start'>start</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>www.example.com</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span> <span class='lbrace'>{</span><span class='op'>|</span><span class='id http'>http</span><span class='op'>|</span>
  <span class='id req'>req</span> <span class='op'>=</span> <span class='const'>Net</span><span class='op'>::</span><span class='const'>HTTP</span><span class='op'>::</span><span class='const'>Get</span><span class='period'>.</span><span class='id new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span>
  <span class='id req'>req</span><span class='period'>.</span><span class='id basic_auth'>basic_auth</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>user</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>pass</span><span class='tstring_end'>'</span></span>
  <span class='id http'>http</span><span class='period'>.</span><span class='id request'>request</span><span class='lparen'>(</span><span class='id req'>req</span><span class='rparen'>)</span>
<span class='rbrace'>}</span>  <span class='comment'># ===&gt; Success
</span></pre>

<h3>Matching uris using regular expressions</h3>

<pre class="code"> <span class='id stub_request'>stub_request</span><span class='lparen'>(</span><span class='symbol'>:any</span><span class='comma'>,</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>.*example.*</span><span class='regexp_end'>/</span></span><span class='rparen'>)</span>

 <span class='const'>Net</span><span class='op'>::</span><span class='const'>HTTP</span><span class='period'>.</span><span class='id get'>get</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>www.example.com</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span> <span class='comment'># ===&gt; Success
</span></pre>

<h3>Matching query params using hash</h3>

<pre class="code"> <span class='id stub_http_request'>stub_http_request</span><span class='lparen'>(</span><span class='symbol'>:get</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>www.example.com</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id with'>with</span><span class='lparen'>(</span><span class='symbol'>:query</span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>a</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>b</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>c</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='rbrace'>}</span><span class='rparen'>)</span>

 <span class='const'>RestClient</span><span class='period'>.</span><span class='id get'>get</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>http://www.example.com/?a[]=b&amp;a[]=c</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='comment'># ===&gt; Success
</span></pre>

<h3>Stubbing with custom response</h3>

<pre class="code"><span class='id stub_request'>stub_request</span><span class='lparen'>(</span><span class='symbol'>:any</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>www.example.com</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id to_return'>to_return</span><span class='lparen'>(</span><span class='symbol'>:body</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>abc</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='symbol'>:status</span> <span class='op'>=&gt;</span> <span class='int'>200</span><span class='comma'>,</span>  <span class='symbol'>:headers</span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>Content-Length</span><span class='tstring_end'>'</span></span> <span class='op'>=&gt;</span> <span class='int'>3</span> <span class='rbrace'>}</span> <span class='rparen'>)</span>

<span class='const'>Net</span><span class='op'>::</span><span class='const'>HTTP</span><span class='period'>.</span><span class='id get'>get</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>www.example.com</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span>    <span class='comment'># ===&gt; &quot;abc&quot;
</span></pre>

<h3>Response with body specified as IO object</h3>

<pre class="code"><span class='const'>File</span><span class='period'>.</span><span class='id open'>open</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/tmp/response_body.txt</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>w</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id f'>f</span><span class='op'>|</span> <span class='id f'>f</span><span class='period'>.</span><span class='id puts'>puts</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>abc</span><span class='tstring_end'>'</span></span> <span class='rbrace'>}</span>

<span class='id stub_request'>stub_request</span><span class='lparen'>(</span><span class='symbol'>:any</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>www.example.com</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id to_return'>to_return</span><span class='lparen'>(</span><span class='symbol'>:body</span> <span class='op'>=&gt;</span> <span class='const'>File</span><span class='period'>.</span><span class='id new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/tmp/response_body.txt</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span><span class='comma'>,</span> <span class='symbol'>:status</span> <span class='op'>=&gt;</span> <span class='int'>200</span><span class='rparen'>)</span>

<span class='const'>Net</span><span class='op'>::</span><span class='const'>HTTP</span><span class='period'>.</span><span class='id get'>get</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>www.example.com</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span>    <span class='comment'># ===&gt; &quot;abc\n&quot;
</span></pre>

<h3>Response with custom status message</h3>

<pre class="code"><span class='id stub_request'>stub_request</span><span class='lparen'>(</span><span class='symbol'>:any</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>www.example.com</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id to_return'>to_return</span><span class='lparen'>(</span><span class='symbol'>:status</span> <span class='op'>=&gt;</span> <span class='lbracket'>[</span><span class='int'>500</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Internal Server Error</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>

<span class='id req'>req</span> <span class='op'>=</span> <span class='const'>Net</span><span class='op'>::</span><span class='const'>HTTP</span><span class='op'>::</span><span class='const'>Get</span><span class='period'>.</span><span class='id new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
<span class='const'>Net</span><span class='op'>::</span><span class='const'>HTTP</span><span class='period'>.</span><span class='id start'>start</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>www.example.com</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id http'>http</span><span class='op'>|</span> <span class='id http'>http</span><span class='period'>.</span><span class='id request'>request</span><span class='lparen'>(</span><span class='id req'>req</span><span class='rparen'>)</span> <span class='rbrace'>}</span><span class='period'>.</span><span class='id message'>message</span> <span class='comment'># ===&gt; &quot;Internal Server Error&quot;
</span></pre>

<h3>Replaying raw responses recorded with <code>curl -is</code></h3>

<pre class="code"><span class='backtick'>`</span><span class='tstring_content'>curl -is www.example.com &gt; /tmp/example_curl_-is_output.txt</span><span class='tstring_end'>`</span></span>
<span class='id raw_response_file'>raw_response_file</span> <span class='op'>=</span> <span class='const'>File</span><span class='period'>.</span><span class='id new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/tmp/example_curl_-is_output.txt</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
</pre>

<p>   from file</p>

<pre class="code"><span class='id stub_request'>stub_request</span><span class='lparen'>(</span><span class='symbol'>:get</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>www.example.com</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id to_return'>to_return</span><span class='lparen'>(</span><span class='id raw_response_file'>raw_response_file</span><span class='rparen'>)</span>
</pre>

<p>   or string</p>

<pre class="code"><span class='id stub_request'>stub_request</span><span class='lparen'>(</span><span class='symbol'>:get</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>www.example.com</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id to_return'>to_return</span><span class='lparen'>(</span><span class='id raw_response_file'>raw_response_file</span><span class='period'>.</span><span class='id read'>read</span><span class='rparen'>)</span>
</pre>

<h3>Responses dynamically evaluated from block</h3>

<pre class="code"><span class='id stub_request'>stub_request</span><span class='lparen'>(</span><span class='symbol'>:any</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>www.example.net</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span><span class='period'>.</span>
  <span class='id to_return'>to_return</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id request'>request</span><span class='op'>|</span> <span class='lbrace'>{</span><span class='symbol'>:body</span> <span class='op'>=&gt;</span> <span class='id request'>request</span><span class='period'>.</span><span class='id body'>body</span><span class='rbrace'>}</span> <span class='rbrace'>}</span>

<span class='const'>RestClient</span><span class='period'>.</span><span class='id post'>post</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>www.example.net</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>abc</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span>    <span class='comment'># ===&gt; &quot;abc\n&quot;
</span></pre>

<h3>Responses dynamically evaluated from lambda</h3>

<pre class="code"><span class='id stub_request'>stub_request</span><span class='lparen'>(</span><span class='symbol'>:any</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>www.example.net</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span><span class='period'>.</span>
  <span class='id to_return'>to_return</span><span class='lparen'>(</span><span class='id lambda'>lambda</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id request'>request</span><span class='op'>|</span> <span class='lbrace'>{</span><span class='symbol'>:body</span> <span class='op'>=&gt;</span> <span class='id request'>request</span><span class='period'>.</span><span class='id body'>body</span><span class='rbrace'>}</span> <span class='rbrace'>}</span><span class='rparen'>)</span>

<span class='const'>RestClient</span><span class='period'>.</span><span class='id post'>post</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>www.example.net</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>abc</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span>    <span class='comment'># ===&gt; &quot;abc\n&quot;
</span></pre>

<h3>Dynamically evaluated raw responses recorded with <code>curl -is</code></h3>

<pre class="code">`curl -is www.example.com &gt; /tmp/www.example.com.txt`
stub_request(:get, &quot;www.example.com&quot;).to_return(lambda { |request| File.new(&quot;/tmp/#{request.uri.host.to_s}.txt&quot; }))
</pre>

<h3>Responses with dynamically evaluated parts</h3>

<pre class="code"><span class='id stub_request'>stub_request</span><span class='lparen'>(</span><span class='symbol'>:any</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>www.example.net</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span><span class='period'>.</span>
  <span class='id to_return'>to_return</span><span class='lparen'>(</span><span class='symbol'>:body</span> <span class='op'>=&gt;</span> <span class='id lambda'>lambda</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id request'>request</span><span class='op'>|</span> <span class='id request'>request</span><span class='period'>.</span><span class='id body'>body</span> <span class='rbrace'>}</span><span class='rparen'>)</span>

<span class='const'>RestClient</span><span class='period'>.</span><span class='id post'>post</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>www.example.net</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>abc</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span>    <span class='comment'># ===&gt; &quot;abc\n&quot;
</span></pre>

<h3>Raising errors</h3>

<h4>Exception declared by class</h4>

<pre class="code"><span class='id stub_request'>stub_request</span><span class='lparen'>(</span><span class='symbol'>:any</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>www.example.net</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id to_raise'>to_raise</span><span class='lparen'>(</span><span class='const'>StandardError</span><span class='rparen'>)</span>

<span class='const'>RestClient</span><span class='period'>.</span><span class='id post'>post</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>www.example.net</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>abc</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span>    <span class='comment'># ===&gt; StandardError
</span></pre>

<h4>or by exception instance</h4>

<pre class="code"><span class='id stub_request'>stub_request</span><span class='lparen'>(</span><span class='symbol'>:any</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>www.example.net</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id to_raise'>to_raise</span><span class='lparen'>(</span><span class='const'>StandardError</span><span class='period'>.</span><span class='id new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>some error</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='rparen'>)</span>
</pre>

<h4>or by string</h4>

<pre class="code"><span class='id stub_request'>stub_request</span><span class='lparen'>(</span><span class='symbol'>:any</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>www.example.net</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id to_raise'>to_raise</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>some error</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
</pre>

<h3>Raising timeout errors</h3>

<pre class="code"><span class='id stub_request'>stub_request</span><span class='lparen'>(</span><span class='symbol'>:any</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>www.example.net</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id to_timeout'>to_timeout</span>

<span class='const'>RestClient</span><span class='period'>.</span><span class='id post'>post</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>www.example.net</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>abc</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span>    <span class='comment'># ===&gt; RestClient::RequestTimeout
</span></pre>

<h3>Multiple responses for repeated requests</h3>

<pre class="code"><span class='id stub_request'>stub_request</span><span class='lparen'>(</span><span class='symbol'>:get</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>www.example.com</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id to_return'>to_return</span><span class='lparen'>(</span><span class='lbrace'>{</span><span class='symbol'>:body</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>abc</span><span class='tstring_end'>&quot;</span></span><span class='rbrace'>}</span><span class='comma'>,</span> <span class='lbrace'>{</span><span class='symbol'>:body</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>def</span><span class='tstring_end'>&quot;</span></span><span class='rbrace'>}</span><span class='rparen'>)</span>
<span class='const'>Net</span><span class='op'>::</span><span class='const'>HTTP</span><span class='period'>.</span><span class='id get'>get</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>www.example.com</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span>    <span class='comment'># ===&gt; &quot;abc\n&quot;
</span><span class='const'>Net</span><span class='op'>::</span><span class='const'>HTTP</span><span class='period'>.</span><span class='id get'>get</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>www.example.com</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span>    <span class='comment'># ===&gt; &quot;def\n&quot;
</span>
<span class='comment'>#after all responses are used the last response will be returned infinitely
</span>
<span class='const'>Net</span><span class='op'>::</span><span class='const'>HTTP</span><span class='period'>.</span><span class='id get'>get</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>www.example.com</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span>    <span class='comment'># ===&gt; &quot;def\n&quot;
</span></pre>

<h3>Multiple responses using chained <code>to_return()</code>, <code>to_raise()</code> or <code>to_timeout</code> declarations</h3>

<pre class="code"><span class='id stub_request'>stub_request</span><span class='lparen'>(</span><span class='symbol'>:get</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>www.example.com</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span>
    <span class='id to_return'>to_return</span><span class='lparen'>(</span><span class='lbrace'>{</span><span class='symbol'>:body</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>abc</span><span class='tstring_end'>&quot;</span></span><span class='rbrace'>}</span><span class='rparen'>)</span><span class='period'>.</span><span class='id then'>then</span><span class='period'>.</span>  <span class='comment'>#then() is just a syntactic sugar
</span>    <span class='id to_return'>to_return</span><span class='lparen'>(</span><span class='lbrace'>{</span><span class='symbol'>:body</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>def</span><span class='tstring_end'>&quot;</span></span><span class='rbrace'>}</span><span class='rparen'>)</span><span class='period'>.</span><span class='id then'>then</span><span class='period'>.</span>
    <span class='id to_raise'>to_raise</span><span class='lparen'>(</span><span class='const'>MyException</span><span class='rparen'>)</span>
<span class='const'>Net</span><span class='op'>::</span><span class='const'>HTTP</span><span class='period'>.</span><span class='id get'>get</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>www.example.com</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span>    <span class='comment'># ===&gt; &quot;abc\n&quot;
</span><span class='const'>Net</span><span class='op'>::</span><span class='const'>HTTP</span><span class='period'>.</span><span class='id get'>get</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>www.example.com</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span>    <span class='comment'># ===&gt; &quot;def\n&quot;
</span><span class='const'>Net</span><span class='op'>::</span><span class='const'>HTTP</span><span class='period'>.</span><span class='id get'>get</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>www.example.com</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span>    <span class='comment'># ===&gt; MyException raised
</span></pre>

<h3>Specifying number of times given response should be returned</h3>

<pre class="code"><span class='id stub_request'>stub_request</span><span class='lparen'>(</span><span class='symbol'>:get</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>www.example.com</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span>
    <span class='id to_return'>to_return</span><span class='lparen'>(</span><span class='lbrace'>{</span><span class='symbol'>:body</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>abc</span><span class='tstring_end'>&quot;</span></span><span class='rbrace'>}</span><span class='rparen'>)</span><span class='period'>.</span><span class='id times'>times</span><span class='lparen'>(</span><span class='int'>2</span><span class='rparen'>)</span><span class='period'>.</span><span class='id then'>then</span><span class='period'>.</span>
    <span class='id to_return'>to_return</span><span class='lparen'>(</span><span class='lbrace'>{</span><span class='symbol'>:body</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>def</span><span class='tstring_end'>&quot;</span></span><span class='rbrace'>}</span><span class='rparen'>)</span>

<span class='const'>Net</span><span class='op'>::</span><span class='const'>HTTP</span><span class='period'>.</span><span class='id get'>get</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>www.example.com</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span>    <span class='comment'># ===&gt; &quot;abc\n&quot;
</span><span class='const'>Net</span><span class='op'>::</span><span class='const'>HTTP</span><span class='period'>.</span><span class='id get'>get</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>www.example.com</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span>    <span class='comment'># ===&gt; &quot;abc\n&quot;
</span><span class='const'>Net</span><span class='op'>::</span><span class='const'>HTTP</span><span class='period'>.</span><span class='id get'>get</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>www.example.com</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span>    <span class='comment'># ===&gt; &quot;def\n&quot;
</span></pre>

<h3>Real requests to network can be allowed or disabled</h3>

<pre class="code"><span class='const'>WebMock</span><span class='period'>.</span><span class='id allow_net_connect!'>allow_net_connect!</span>

<span class='id stub_request'>stub_request</span><span class='lparen'>(</span><span class='symbol'>:any</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>www.example.com</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id to_return'>to_return</span><span class='lparen'>(</span><span class='symbol'>:body</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>abc</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>

<span class='const'>Net</span><span class='op'>::</span><span class='const'>HTTP</span><span class='period'>.</span><span class='id get'>get</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>www.example.com</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span>    <span class='comment'># ===&gt; &quot;abc&quot;
</span>
<span class='const'>Net</span><span class='op'>::</span><span class='const'>HTTP</span><span class='period'>.</span><span class='id get'>get</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>www.something.com</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span> <span class='comment'># ===&gt; /.+Something.+/
</span>
<span class='const'>WebMock</span><span class='period'>.</span><span class='id disable_net_connect!'>disable_net_connect!</span>

<span class='const'>Net</span><span class='op'>::</span><span class='const'>HTTP</span><span class='period'>.</span><span class='id get'>get</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>www.something.com</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span>    <span class='comment'># ===&gt; Failure
</span></pre>

<h3>External requests can be disabled while allowing localhost</h3>

<pre class="code"><span class='const'>WebMock</span><span class='period'>.</span><span class='id disable_net_connect!'>disable_net_connect!</span><span class='lparen'>(</span><span class='symbol'>:allow_localhost</span> <span class='op'>=&gt;</span> <span class='kw'>true</span><span class='rparen'>)</span>

<span class='const'>Net</span><span class='op'>::</span><span class='const'>HTTP</span><span class='period'>.</span><span class='id get'>get</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>www.something.com</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span>   <span class='comment'># ===&gt; Failure
</span>
<span class='const'>Net</span><span class='op'>::</span><span class='const'>HTTP</span><span class='period'>.</span><span class='id get'>get</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>localhost:9887</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span>      <span class='comment'># ===&gt; Allowed. Perhaps to Selenium?
</span></pre>

<h3>External requests can be disabled while allowing any hostname</h3>

<pre class="code"><span class='const'>WebMock</span><span class='period'>.</span><span class='id disable_net_connect!'>disable_net_connect!</span><span class='lparen'>(</span><span class='symbol'>:allow</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>www.example.org</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>

<span class='const'>Net</span><span class='op'>::</span><span class='const'>HTTP</span><span class='period'>.</span><span class='id get'>get</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>www.something.com</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span>   <span class='comment'># ===&gt; Failure
</span>
<span class='const'>Net</span><span class='op'>::</span><span class='const'>HTTP</span><span class='period'>.</span><span class='id get'>get</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>www.example.org</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span>      <span class='comment'># ===&gt; Allowed.
</span></pre>

<h2>Connecting on Net::HTTP.start</h2>

<p>HTTP protocol has 3 steps: connect, request and response (or 4 with close). Most Ruby HTTP client libraries
treat connect as a part of request step, with the exception of <code>Net::HTTP</code> which
allows opening connection to the server separately to the request, by using <code>Net::HTTP.start</code>.</p>

<p>WebMock API was also designed with connect being part of request step, and it only allows stubbing
requests, not connections. When <code>Net::HTTP.start</code> is called, WebMock doesn't know yet whether
a request is stubbed or not. WebMock by default delays a connection until the request is invoked,
so when there is no request, <code>Net::HTTP.start</code> doesn't do anything.
<strong>This means that WebMock breaks the Net::HTTP behaviour by default!</strong></p>

<p>To workaround this issue, WebMock offers <code>:net_http_connect_on_start</code> option,
which can be passed to <code>WebMock.allow_net_connect!</code> and <code>WebMock#disable_net_connect!</code> methods, i.e.</p>

<pre class="code"><span class='const'>WebMock</span><span class='period'>.</span><span class='id allow_net_connect!'>allow_net_connect!</span><span class='lparen'>(</span><span class='symbol'>:net_http_connect_on_start</span> <span class='op'>=&gt;</span> <span class='kw'>true</span><span class='rparen'>)</span>
</pre>

<p>This forces WebMock Net::HTTP adapter to always connect on <code>Net::HTTP.start</code>.</p>

<h2>Setting Expectations</h2>

<h3>Setting expectations in Test::Unit</h3>

<pre class="code"><span class='id require'>require</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>webmock/test_unit</span><span class='tstring_end'>'</span></span>

<span class='id stub_request'>stub_request</span><span class='lparen'>(</span><span class='symbol'>:any</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>www.example.com</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>

<span class='id uri'>uri</span> <span class='op'>=</span> <span class='const'>URI</span><span class='period'>.</span><span class='id parse'>parse</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>http://www.example.com/</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span>
<span class='id req'>req</span> <span class='op'>=</span> <span class='const'>Net</span><span class='op'>::</span><span class='const'>HTTP</span><span class='op'>::</span><span class='const'>Post</span><span class='period'>.</span><span class='id new'>new</span><span class='lparen'>(</span><span class='id uri'>uri</span><span class='period'>.</span><span class='id path'>path</span><span class='rparen'>)</span>
<span class='id req'>req</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>Content-Length</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='int'>3</span>
<span class='id res'>res</span> <span class='op'>=</span> <span class='const'>Net</span><span class='op'>::</span><span class='const'>HTTP</span><span class='period'>.</span><span class='id start'>start</span><span class='lparen'>(</span><span class='id uri'>uri</span><span class='period'>.</span><span class='id host'>host</span><span class='comma'>,</span> <span class='id uri'>uri</span><span class='period'>.</span><span class='id port'>port</span><span class='rparen'>)</span> <span class='lbrace'>{</span><span class='op'>|</span><span class='id http'>http</span><span class='op'>|</span>
  <span class='id http'>http</span><span class='period'>.</span><span class='id request'>request</span><span class='lparen'>(</span><span class='id req'>req</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>abc</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span>
<span class='rbrace'>}</span>

<span class='id assert_requested'>assert_requested</span> <span class='symbol'>:post</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>http://www.example.com</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
  <span class='symbol'>:headers</span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>Content-Length</span><span class='tstring_end'>'</span></span> <span class='op'>=&gt;</span> <span class='int'>3</span><span class='rbrace'>}</span><span class='comma'>,</span> <span class='symbol'>:body</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>abc</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='symbol'>:times</span> <span class='op'>=&gt;</span> <span class='int'>1</span>    <span class='comment'># ===&gt; Success
</span>
<span class='id assert_not_requested'>assert_not_requested</span> <span class='symbol'>:get</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>http://www.something.com</span><span class='tstring_end'>&quot;</span></span>    <span class='comment'># ===&gt; Success
</span>
<span class='id assert_requested'>assert_requested</span><span class='lparen'>(</span><span class='symbol'>:post</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>http://www.example.com</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='symbol'>:times</span> <span class='op'>=&gt;</span> <span class='int'>1</span><span class='rparen'>)</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id req'>req</span><span class='op'>|</span> <span class='id req'>req</span><span class='period'>.</span><span class='id body'>body</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>abc</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span>
</pre>

<h3>Expecting real (not stubbed) requests</h3>

<pre class="code"><span class='const'>WebMock</span><span class='period'>.</span><span class='id allow_net_connect!'>allow_net_connect!</span>

<span class='const'>Net</span><span class='op'>::</span><span class='const'>HTTP</span><span class='period'>.</span><span class='id get'>get</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>www.example.com</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span>    <span class='comment'># ===&gt; Success
</span>
<span class='id assert_requested'>assert_requested</span> <span class='symbol'>:get</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>http://www.example.com</span><span class='tstring_end'>&quot;</span></span>    <span class='comment'># ===&gt; Success
</span></pre>

<h3>Setting expectations in RSpec</h3>

<p> This style is borrowed from <a href="http://github.com/freelancing-god/fakeweb-matcher">fakeweb-matcher</a></p>

<pre class="code"><span class='id require'>require</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>webmock/rspec</span><span class='tstring_end'>'</span></span>

<span class='const'>WebMock</span><span class='period'>.</span><span class='id should'>should</span> <span class='id have_requested'>have_requested</span><span class='lparen'>(</span><span class='symbol'>:get</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>www.example.com</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id with'>with</span><span class='lparen'>(</span><span class='symbol'>:body</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>abc</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='symbol'>:headers</span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>Content-Length</span><span class='tstring_end'>'</span></span> <span class='op'>=&gt;</span> <span class='int'>3</span><span class='rbrace'>}</span><span class='rparen'>)</span><span class='period'>.</span><span class='id twice'>twice</span>

<span class='const'>WebMock</span><span class='period'>.</span><span class='id should_not'>should_not</span> <span class='id have_requested'>have_requested</span><span class='lparen'>(</span><span class='symbol'>:get</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>www.something.com</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>

<span class='const'>WebMock</span><span class='period'>.</span><span class='id should'>should</span> <span class='id have_requested'>have_requested</span><span class='lparen'>(</span><span class='symbol'>:post</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>www.example.com</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id with'>with</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id req'>req</span><span class='op'>|</span> <span class='id req'>req</span><span class='period'>.</span><span class='id body'>body</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>abc</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span>

<span class='const'>WebMock</span><span class='period'>.</span><span class='id should'>should</span> <span class='id have_requested'>have_requested</span><span class='lparen'>(</span><span class='symbol'>:get</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>www.example.com</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id with'>with</span><span class='lparen'>(</span><span class='symbol'>:query</span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>a</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>b</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>c</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='rbrace'>}</span><span class='rparen'>)</span>

<span class='const'>WebMock</span><span class='period'>.</span><span class='id should'>should</span> <span class='id have_requested'>have_requested</span><span class='lparen'>(</span><span class='symbol'>:get</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>www.example.com</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span>
  <span class='id with'>with</span><span class='lparen'>(</span><span class='symbol'>:body</span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>a</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>b</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>c</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='rbrace'>}</span><span class='comma'>,</span> <span class='symbol'>:headers</span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>Content-Type</span><span class='tstring_end'>'</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>application/json</span><span class='tstring_end'>'</span></span><span class='rbrace'>}</span><span class='rparen'>)</span>
</pre>

<h3>Different way of setting expectations in RSpec</h3>

<pre class="code"><span class='id a_request'>a_request</span><span class='lparen'>(</span><span class='symbol'>:post</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>www.example.com</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id with'>with</span><span class='lparen'>(</span><span class='symbol'>:body</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>abc</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='symbol'>:headers</span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>Content-Length</span><span class='tstring_end'>'</span></span> <span class='op'>=&gt;</span> <span class='int'>3</span><span class='rbrace'>}</span><span class='rparen'>)</span><span class='period'>.</span><span class='id should'>should</span> <span class='id have_been_made'>have_been_made</span><span class='period'>.</span><span class='id once'>once</span>

<span class='id a_request'>a_request</span><span class='lparen'>(</span><span class='symbol'>:post</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>www.something.com</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id should'>should</span> <span class='id have_been_made'>have_been_made</span><span class='period'>.</span><span class='id times'>times</span><span class='lparen'>(</span><span class='int'>3</span><span class='rparen'>)</span>

<span class='id a_request'>a_request</span><span class='lparen'>(</span><span class='symbol'>:any</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>www.example.com</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id should_not'>should_not</span> <span class='id have_been_made'>have_been_made</span>

<span class='id a_request'>a_request</span><span class='lparen'>(</span><span class='symbol'>:post</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>www.example.com</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id with'>with</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id req'>req</span><span class='op'>|</span> <span class='id req'>req</span><span class='period'>.</span><span class='id body'>body</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>abc</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span><span class='period'>.</span><span class='id should'>should</span> <span class='id have_been_made'>have_been_made</span>

<span class='id a_request'>a_request</span><span class='lparen'>(</span><span class='symbol'>:get</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>www.example.com</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id with'>with</span><span class='lparen'>(</span><span class='symbol'>:query</span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>a</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>b</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>c</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='rbrace'>}</span><span class='rparen'>)</span><span class='period'>.</span><span class='id should'>should</span> <span class='id have_been_made'>have_been_made</span>

<span class='id a_request'>a_request</span><span class='lparen'>(</span><span class='symbol'>:post</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>www.example.com</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span>
  <span class='id with'>with</span><span class='lparen'>(</span><span class='symbol'>:body</span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>a</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>b</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>c</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='rbrace'>}</span><span class='comma'>,</span> <span class='symbol'>:headers</span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>Content-Type</span><span class='tstring_end'>'</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>application/json</span><span class='tstring_end'>'</span></span><span class='rbrace'>}</span><span class='rparen'>)</span><span class='period'>.</span><span class='id should'>should</span> <span class='id have_been_made'>have_been_made</span>
</pre>

<h2>Clearing stubs and request history</h2>

<p>If you want to reset all current stubs and history of requests use <code>WebMock.reset!</code></p>

<pre class="code"><span class='id stub_request'>stub_request</span><span class='lparen'>(</span><span class='symbol'>:any</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>www.example.com</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>

<span class='const'>Net</span><span class='op'>::</span><span class='const'>HTTP</span><span class='period'>.</span><span class='id get'>get</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>www.example.com</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span>    <span class='comment'># ===&gt; Success
</span>
<span class='const'>WebMock</span><span class='period'>.</span><span class='id reset!'>reset!</span>

<span class='const'>Net</span><span class='op'>::</span><span class='const'>HTTP</span><span class='period'>.</span><span class='id get'>get</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>www.example.com</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span>    <span class='comment'># ===&gt; Failure
</span>
<span class='id assert_not_requested'>assert_not_requested</span> <span class='symbol'>:get</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>www.example.com</span><span class='tstring_end'>&quot;</span></span>    <span class='comment'># ===&gt; Success
</span></pre>

<h2>Matching requests</h2>

<p>An executed request matches stubbed request if it passes following criteria:</p>

<p>  When request URI matches stubbed request URI string or Regexp pattern<br/>
  And request method is the same as stubbed request method or stubbed request method is :any<br/>
  And request body is the same as stubbed request body or stubbed request body is not specified<br/>
  And request headers match stubbed request headers, or stubbed request headers match a subset of request headers, or stubbed request headers are not specified<br/>
  And request matches provided block or block is not provided</p>

<h2>Precedence of stubs</h2>

<p>Always the last declared stub matching the request will be applied i.e:</p>

<pre class="code"><span class='id stub_request'>stub_request</span><span class='lparen'>(</span><span class='symbol'>:get</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>www.example.com</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id to_return'>to_return</span><span class='lparen'>(</span><span class='symbol'>:body</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>abc</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
<span class='id stub_request'>stub_request</span><span class='lparen'>(</span><span class='symbol'>:get</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>www.example.com</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id to_return'>to_return</span><span class='lparen'>(</span><span class='symbol'>:body</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>def</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>

<span class='const'>Net</span><span class='op'>::</span><span class='const'>HTTP</span><span class='period'>.</span><span class='id get'>get</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>www.example.com</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span>   <span class='comment'># ====&gt; &quot;def&quot;
</span></pre>

<h2>Matching URIs</h2>

<p>WebMock will match all different representations of the same URI.</p>

<p>I.e all the following representations of the URI are equal:</p>

<pre class="code"><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>www.example.com</span><span class='tstring_end'>&quot;</span></span>
<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>www.example.com/</span><span class='tstring_end'>&quot;</span></span>
<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>www.example.com:80</span><span class='tstring_end'>&quot;</span></span>
<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>www.example.com:80/</span><span class='tstring_end'>&quot;</span></span>
<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>http://www.example.com</span><span class='tstring_end'>&quot;</span></span>
<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>http://www.example.com/</span><span class='tstring_end'>&quot;</span></span>
<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>http://www.example.com:80</span><span class='tstring_end'>&quot;</span></span>
<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>http://www.example.com:80/</span><span class='tstring_end'>&quot;</span></span>
</pre>

<p>The following URIs with basic authentication are also equal for WebMock</p>

<pre class="code"><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>a b:pass@www.example.com</span><span class='tstring_end'>&quot;</span></span>
<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>a b:pass@www.example.com/</span><span class='tstring_end'>&quot;</span></span>
<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>a b:pass@www.example.com:80</span><span class='tstring_end'>&quot;</span></span>
<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>a b:pass@www.example.com:80/</span><span class='tstring_end'>&quot;</span></span>
<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>http://a b:pass@www.example.com</span><span class='tstring_end'>&quot;</span></span>
<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>http://a b:pass@www.example.com/</span><span class='tstring_end'>&quot;</span></span>
<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>http://a b:pass@www.example.com:80</span><span class='tstring_end'>&quot;</span></span>
<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>http://a b:pass@www.example.com:80/</span><span class='tstring_end'>&quot;</span></span>
<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>a%20b:pass@www.example.com</span><span class='tstring_end'>&quot;</span></span>
<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>a%20b:pass@www.example.com/</span><span class='tstring_end'>&quot;</span></span>
<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>a%20b:pass@www.example.com:80</span><span class='tstring_end'>&quot;</span></span>
<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>a%20b:pass@www.example.com:80/</span><span class='tstring_end'>&quot;</span></span>
<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>http://a%20b:pass@www.example.com</span><span class='tstring_end'>&quot;</span></span>
<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>http://a%20b:pass@www.example.com/</span><span class='tstring_end'>&quot;</span></span>
<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>http://a%20b:pass@www.example.com:80</span><span class='tstring_end'>&quot;</span></span>
<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>http://a%20b:pass@www.example.com:80/</span><span class='tstring_end'>&quot;</span></span>
</pre>

<p>or these</p>

<pre class="code"><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>www.example.com/my path/?a=my param&amp;b=c</span><span class='tstring_end'>&quot;</span></span>
<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>www.example.com/my%20path/?a=my%20param&amp;b=c</span><span class='tstring_end'>&quot;</span></span>
<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>www.example.com:80/my path/?a=my param&amp;b=c</span><span class='tstring_end'>&quot;</span></span>
<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>www.example.com:80/my%20path/?a=my%20param&amp;b=c</span><span class='tstring_end'>&quot;</span></span>
<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>http://www.example.com/my path/?a=my param&amp;b=c</span><span class='tstring_end'>&quot;</span></span>
<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>http://www.example.com/my%20path/?a=my%20param&amp;b=c</span><span class='tstring_end'>&quot;</span></span>
<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>http://www.example.com:80/my path/?a=my param&amp;b=c</span><span class='tstring_end'>&quot;</span></span>
<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>http://www.example.com:80/my%20path/?a=my%20param&amp;b=c</span><span class='tstring_end'>&quot;</span></span>
</pre>

<p>If you provide Regexp to match URI, WebMock will try to match it against every valid form of the same url.</p>

<p>I.e <code>/.*my param.*/</code> will match <code>www.example.com/my%20path</code> because it is equivalent of <code>www.example.com/my path</code></p>

<h2>Matching headers</h2>

<p>WebMock will match request headers against stubbed request headers in the following situations:</p>

<ol>
<li><p>Stubbed request has headers specified and request headers are the same as stubbed headers <br/>
i.e stubbed headers: <code>{ 'Header1' =&gt; 'Value1', 'Header1' =&gt; 'Value1' }</code>, requested: <code>{ 'Header1' =&gt; 'Value1', 'Header1' =&gt; 'Value1' }</code></p></li>
<li><p>Stubbed request has headers specified and stubbed request headers are a subset of request headers <br/>
i.e stubbed headers: <code>{ 'Header1' =&gt; 'Value1'  }</code>, requested: <code>{ 'Header1' =&gt; 'Value1', 'Header1' =&gt; 'Value1' }</code></p></li>
<li><p>Stubbed request has no headers <br/>
i.e stubbed headers: <code>nil</code>, requested: <code>{ 'Header1' =&gt; 'Value1', 'Header1' =&gt; 'Value1' }</code></p></li>
</ol>


<p>WebMock normalises headers and treats all forms of same headers as equal:
i.e the following two sets of headers are equal:</p>

<p><code>{ "Header1" =&gt; "value1", :content_length =&gt; 123, :X_CuStOm_hEAder =&gt; :value }</code></p>

<p><code>{ :header1 =&gt; "value1",  "Content-Length" =&gt; 123, "x-cuSTOM-HeAder" =&gt; "value" }</code></p>

<h2>Recording real requests and responses and replaying them later</h2>

<p>To record your application's real HTTP interactions and replay them later in tests you can use <a href="http://github.com/myronmarston/vcr">VCR</a> with WebMock.</p>

<h2>Request callbacks</h2>

<h4>WebMock can invoke callbacks stubbed or real requests:</h4>

<pre class="code"><span class='const'>WebMock</span><span class='period'>.</span><span class='id after_request'>after_request</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id request_signature'>request_signature</span><span class='comma'>,</span> <span class='id response'>response</span><span class='op'>|</span>
  <span class='id puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Request </span><span class='embexpr_beg'>#{</span><span class='id request_signature'>request_signature</span><span class='rbrace'>}</span><span class='tstring_content'> was made and </span><span class='embexpr_beg'>#{</span><span class='id response'>response</span><span class='rbrace'>}</span><span class='tstring_content'> was returned</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>
</pre>

<h4>invoke callbacks for real requests only and except requests made with Patron</h4>

<pre class="code"><span class='const'>WebMock</span><span class='period'>.</span><span class='id after_request'>after_request</span><span class='lparen'>(</span><span class='symbol'>:except</span> <span class='op'>=&gt;</span> <span class='lbracket'>[</span><span class='symbol'>:patron</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='symbol'>:real_requests_only</span> <span class='op'>=&gt;</span> <span class='kw'>true</span><span class='rparen'>)</span>  <span class='kw'>do</span> <span class='op'>|</span><span class='id request_signature'>request_signature</span><span class='comma'>,</span> <span class='id response'>response</span><span class='op'>|</span>
  <span class='id puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Request </span><span class='embexpr_beg'>#{</span><span class='id request_signature'>request_signature</span><span class='rbrace'>}</span><span class='tstring_content'> was made and </span><span class='embexpr_beg'>#{</span><span class='id response'>response</span><span class='rbrace'>}</span><span class='tstring_content'> was returned</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>
</pre>

<h2>Bugs and Issues</h2>

<p>Please submit them here <a href="http://github.com/bblimke/webmock/issues">http://github.com/bblimke/webmock/issues</a></p>

<h2>Suggestions</h2>

<p>If you have any suggestions on how to improve WebMock please send an email to the mailing list <a href="http://groups.google.com/group/webmock-users">groups.google.com/group/webmock-users</a></p>

<p>I'm particularly interested in how the DSL could be improved.</p>

<h2>Development</h2>

<p>In order to work on Webmock you first need to fork and clone the repo.
Please do any work on a dedicated branch and rebase against master
before sending a pull request.</p>

<h4>Running Tests</h4>

<p>We use RVM in order to test WebMock against 1.8.6, REE, 1.8.7, 1.9.2 and
jRuby.  You can get RVM setup for WebMock development using the
following commands (if you don't have these version of Ruby installed
use <code>rvm install</code> to install each of them).</p>

<pre class="code">rvm use --create 1.8.6@webmock
gem install jeweler bundler
bundle install

rvm use --create ree@webmock
gem install jeweler bundler
bundle install

rvm use --create 1.8.7@webmock
gem install jeweler bundler
bundle install

rvm use --create 1.9.2@webmock
gem install jeweler bundler
bundle install

rvm use --create jruby@webmock
gem install jeweler bundler
bundle install
</pre>

<p>These commands will create a gemset named WebMock for each of the
supported versions of Ruby and <code>bundle install</code> all dependencies.</p>

<p>With the supported versions of Ruby installed RVM will run specs across
all version with just one command.</p>

<pre class="code">bundle exec rvm 1.8.6@webmock,ree@webmock,1.8.7@webmock,1.9.2@webmock,jruby@webmock rspec spec/**/*_spec.rb
</pre>

<p>This command is wrapped up in to a rake task and can be invoked like so:</p>

<pre class="code"><span class='id rake'>rake</span> <span class='label'>spec:</span><span class='id rubies'>rubies</span>
</pre>

<h2>Credits</h2>

<p>The initial lines of this project were written during New Bamboo <a href="http://blog.new-bamboo.co.uk/2009/11/13/hackday-results">Hack Day</a>
Thanks to my fellow <a href="http://new-bamboo.co.uk/">Bambinos</a> for all the great suggestions!</p>

<p>People who submitted patches and new features or suggested improvements. Many thanks to these people:</p>

<ul>
<li>Ben Pickles</li>
<li>Mark Evans</li>
<li>Ivan Vega</li>
<li>Piotr Usewicz</li>
<li>Nick Plante</li>
<li>Nick Quaranto</li>
<li>Diego E. "Flameeyes" Petten</li>
<li>Niels Meersschaert</li>
<li>Mack Earnhardt</li>
<li>Arvicco</li>
<li>Sergio Gil</li>
<li>Jeffrey Jones</li>
<li>Tekin Suleyman</li>
<li>Tom Ward</li>
<li>Nadim Bitar</li>
<li>Myron Marston</li>
<li>Sam Phillips</li>
<li>Jose Angel Cortinas</li>
<li>Razic</li>
<li>Steve Tooke</li>
<li>Nathaniel Bibler</li>
<li>Martyn Loughran</li>
<li>Muness Alrubaie</li>
<li>Charles Li</li>
<li>Ryan Bigg</li>
<li>Pete Higgins</li>
<li>Hans de Graaff</li>
<li>Alastair Brunton</li>
<li>Sam Stokes</li>
<li>Eugene Bolshakov</li>
</ul>


<p>For a full list of contributors you can visit the
<a href="https://github.com/bblimke/webmock/contributors">contributors</a> page.</p>

<h2>Background</h2>

<p>Thank you Fakeweb! This library was inspired by <a href="fakeweb.rubyforge.org">FakeWeb</a>.
I imported some solutions from that project to WebMock. I also copied some code i.e Net:HTTP adapter.
Fakeweb architecture unfortunately didn't allow me to extend it easily with the features I needed.
I also preferred some things to work differently i.e request stub precedence.</p>

<h2>Copyright</h2>

<p>Copyright (c) 2009-2010 Bartosz Blimke. See LICENSE for details.</p>
</div></div>
    
    <div id="footer">
  Generated on Sun Jul  3 13:36:31 2011 by 
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.7.2 (ruby-1.9.2).
</div>

  </body>
</html>